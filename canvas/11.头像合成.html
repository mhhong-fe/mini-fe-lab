<!DOCTYPE html>
<html lang="zh-CN">
    <head>
        <meta charset="UTF-8" />
        <title>Canvas 图片合成 + 预览 Demo</title>
        <style>
            body {
                display: flex;
                flex-direction: column;
                align-items: center;
                padding: 40px;
                font-family: system-ui, sans-serif;
            }
            canvas {
                border: 1px solid #ccc;
                margin-bottom: 20px;
            }
            .preview {
                margin-top: 10px;
                border: 1px solid #ddd;
                width: 300px; /* 预览尺寸，可缩放 */
                height: 200px;
                object-fit: contain;
            }

            button {
                margin-top: 60px;
            }
        </style>
    </head>
    <body>
        <canvas id="canvas" width="600" height="400"></canvas>
        <img id="preview" class="preview" alt="实时预览" />
        <button id="export">导出合成图片</button>

        <script>
            const canvas = document.getElementById("canvas");
            const ctx = canvas.getContext("2d");

            const LOGICAL_WIDTH = 600;
            const LOGICAL_HEIGHT = 400;

            // 高分屏适配
            const dpr = window.devicePixelRatio || 1;
            canvas.width = LOGICAL_WIDTH * dpr;
            canvas.height = LOGICAL_HEIGHT * dpr;
            canvas.style.width = LOGICAL_WIDTH + "px";
            canvas.style.height = LOGICAL_HEIGHT + "px";
            ctx.scale(dpr, dpr);

            // 数据源
            const images = [
                {
                    src: "./11.多人角色头像合成/imgs/avatar1.webp",
                    x: 0,
                    y: 0,
                    w: 300,
                    h: 400,
                    img: null,
                },
                {
                    src: "./11.多人角色头像合成/imgs/avatar2.webp",
                    x: 300,
                    y: 0,
                    w: 300,
                    h: 400,
                    img: null,
                },
            ];

            // 加载图片
            let loadedCount = 0;
            images.forEach((item) => {
                const img = new Image();
                img.src = item.src;
                img.onload = () => {
                    item.img = img;
                    loadedCount++;
                    if (loadedCount === images.length) {
                        render(); // 全部图片加载完成
                    }
                };
            });

            // 渲染函数
            function render() {
                ctx.clearRect(0, 0, LOGICAL_WIDTH, LOGICAL_HEIGHT);
                images.forEach((item) => {
                    if (item.img) {
                        ctx.drawImage(item.img, item.x, item.y, item.w, item.h);
                    }
                });
                updatePreview();
            }

            // 实时预览
            function updatePreview() {
                const preview = document.getElementById("preview");
                // 转为 DataURL 并更新 <img>
                preview.src = canvas.toDataURL("image/png");
            }

            // 导出合成图片
            document.getElementById("export").addEventListener("click", () => {
                const dataURL = canvas.toDataURL("image/png");
                const link = document.createElement("a");
                link.href = dataURL;
                link.download = "composed.png";
                link.click();
            });
        </script>
    </body>
</html>
